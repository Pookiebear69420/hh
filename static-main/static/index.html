<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZenZUltraFast</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" type="image/x-icon" href="logo.png">

  <style>
    /* === CSS Variables for Dynamic Themes === */
    :root {
      --primary-color: #00ff41;
      --secondary-color: #00cc33;
      --bg-color: #0d1b0f;
      --bg-gradient: linear-gradient(180deg, #1a331d 0%, #0d1b0f 100%);
    }

    /* === Animations === */
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 8px var(--primary-color); }
      50% { box-shadow: 0 0 16px var(--primary-color); }
    }

    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slide-right {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    @keyframes message-appear {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === Base Reset === */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: #fff;
      font-family: 'Open Sans', sans-serif;
      overflow: hidden;
    }

    .main-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* === Theme Classes === */
    .theme-red {
      --primary-color: #ff0000;
      --secondary-color: #cc0000;
      --bg-color: #000000;
      --bg-gradient: linear-gradient(180deg, #111 0%, #000 100%);
    }

    .theme-blue {
      --primary-color: #0080ff;
      --secondary-color: #0066cc;
      --bg-color: #001122;
      --bg-gradient: linear-gradient(180deg, #003366 0%, #001122 100%);
    }

    .theme-purple {
      --primary-color: #8a2be2;
      --secondary-color: #6a1b9a;
      --bg-color: #1a0d26;
      --bg-gradient: linear-gradient(180deg, #2d1b3d 0%, #1a0d26 100%);
    }

    .theme-green {
      --primary-color: #00ff41;
      --secondary-color: #00cc33;
      --bg-color: #0d1b0f;
      --bg-gradient: linear-gradient(180deg, #1a331d 0%, #0d1b0f 100%);
    }

    .theme-gold {
      --primary-color: #ffd700;
      --secondary-color: #ffb700;
      --bg-color: #1a1a0d;
      --bg-gradient: linear-gradient(180deg, #333322 0%, #1a1a0d 100%);
    }

    /* === Left Navigation Bar === */
    .nav-sidebar {
      width: 200px;
      background: var(--bg-gradient);
      border-right: 2px solid #333;
      box-shadow: 2px 0 10px rgba(0, 255, 65, 0.3);
      display: flex;
      flex-direction: column;
      animation: slide-right 0.8s ease-out;
    }

    .nav-sidebar h3 {
      color: var(--primary-color);
      text-align: center;
      padding: 20px 10px;
      margin: 0;
      border-bottom: 1px solid #333;
      text-shadow: 0 0 8px var(--primary-color);
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      color: #ccc;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-item:hover {
      background: linear-gradient(90deg, #222 0%, #111 100%);
      border-left-color: var(--primary-color);
      color: #fff;
      text-shadow: 0 0 5px var(--primary-color);
      animation: bounce 0.6s ease;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #333 0%, #222 100%);
      border-left-color: var(--secondary-color);
      color: var(--secondary-color);
      text-shadow: 0 0 8px var(--primary-color);
    }

    .nav-item i {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    /* === Browser Content Area === */
    .browser-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    /* === Chat Screen === */
    .chat-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-gradient);
      animation: fade-in 1s ease-out;
    }

    .chat-screen.active {
      display: flex;
    }

    /* === Online Counter === */
    .online-counter {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--primary-color);
      border-radius: 25px;
      padding: 10px 20px;
      color: var(--primary-color);
      font-weight: bold;
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .online-dot {
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: pulse-glow 2s infinite;
    }

    /* === Username Setup === */
    .username-setup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid var(--primary-color);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 255, 65, 0.5);
      z-index: 200;
      min-width: 300px;
    }

    .username-setup.hidden {
      display: none;
    }

    .username-setup h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-shadow: 0 0 10px var(--primary-color);
    }

    .username-setup input {
      width: 100%;
      padding: 15px;
      background: #222;
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .username-setup input:focus {
      outline: none;
      box-shadow: 0 0 15px var(--primary-color);
    }

    .username-setup button {
      width: 100%;
      padding: 15px;
      background: var(--primary-color);
      border: none;
      border-radius: 10px;
      color: #000;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .username-setup button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 20px var(--primary-color);
    }

    /* === Chat Container === */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-top: 80px; /* Space for online counter */
    }

    /* === Chat Messages === */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(0, 255, 65, 0.2);
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 15px;
      animation: message-appear 0.5s ease-out;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }

    .message-sender {
      color: var(--primary-color);
      font-weight: bold;
      text-shadow: 0 0 5px var(--primary-color);
    }

    .message-time {
      color: #666;
      font-size: 12px;
    }

    .message-content {
      background: rgba(0, 255, 65, 0.1);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0, 255, 65, 0.2);
      color: #fff;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.own .message-sender {
      color: #ffd700;
      text-shadow: 0 0 5px #ffd700;
    }

    .message.own .message-content {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.2);
    }

    .message.system .message-sender {
      color: #888;
    }

    .message.system .message-content {
      background: rgba(136, 136, 136, 0.1);
      border-color: rgba(136, 136, 136, 0.2);
      font-style: italic;
    }

    /* === File Messages === */
    .message-file {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin-top: 8px;
    }

    .file-icon {
      color: var(--primary-color);
      font-size: 24px;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      color: #fff;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .file-size {
      color: #888;
      font-size: 12px;
    }

    .file-download {
      background: var(--primary-color);
      color: #000;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .file-download:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    .message-image {
      max-width: 300px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .message-image:hover {
      transform: scale(1.05);
    }

    /* === Chat Input === */
    .chat-input-area {
      display: flex;
      gap: 15px;
      align-items: flex-end;
    }

    .input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-input {
      min-height: 50px;
      max-height: 120px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid var(--primary-color);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      resize: none;
      font-family: inherit;
    }

    .chat-input:focus {
      outline: none;
      box-shadow: 0 0 15px var(--primary-color);
    }

    .file-buttons {
      display: flex;
      gap: 8px;
    }

    .file-btn {
      background: rgba(0, 255, 65, 0.2);
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }

    .file-btn:hover {
      background: var(--primary-color);
      color: #000;
    }

    .file-input {
      display: none;
    }

    .selected-files {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .selected-file {
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid var(--primary-color);
      padding: 4px 8px;
      border-radius: 12px;
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .remove-file {
      color: #ff4444;
      cursor: pointer;
      font-weight: bold;
      margin-left: 5px;
    }

    .send-button {
      background: var(--primary-color);
      border: none;
      border-radius: 12px;
      color: #000;
      padding: 15px 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      height: fit-content;
    }

    .send-button:hover:not(:disabled) {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px var(--primary-color);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* === Welcome Screen === */
    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg-gradient);
      animation: fade-in 1s ease-out;
      padding: 30px;
    }

    .welcome-screen.active {
      display: flex;
    }

    .welcome-screen:not(.active) {
      display: none;
    }

    .welcome-screen h1 {
      font-size: 3em;
      color: var(--primary-color);
      text-shadow: 0 0 20px var(--primary-color);
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 3px;
      animation: pulse-glow 3s ease infinite;
    }

    /* === Modal === */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }

    .modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      color: #fff;
      font-size: 30px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
    }

    /* === Mobile Responsive === */
    @media (max-width: 768px) {
      .nav-sidebar {
        width: 60px;
      }
      
      .nav-item span {
        display: none;
      }
      
      .online-counter {
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 14px;
      }
      
      .username-setup {
        min-width: 280px;
        margin: 0 20px;
      }
      
      .chat-container {
        padding: 10px;
        padding-top: 60px;
      }
      
      .chat-input-area {
        flex-direction: column;
        gap: 10px;
      }
      
      .send-button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body class="theme-green">
  <div class="main-container">
    <!-- Left Navigation Sidebar -->
    <div class="nav-sidebar">
      <h3>ZenZ Menu</h3>
      <div class="nav-item" data-section="proxy">
        <i class="fas fa-globe"></i>
        <span>Proxy</span>
      </div>
      <div class="nav-item active" data-section="welcome">
        <i class="fas fa-home"></i>
        <span>Welcome</span>
      </div>
      <div class="nav-item" data-section="chatting">
        <i class="fas fa-comments"></i>
        <span>Chat</span>
      </div>
      <div class="nav-item" data-section="games">
        <i class="fas fa-gamepad"></i>
        <span>Games</span>
      </div>
      <div class="nav-item" data-section="ai">
        <i class="fas fa-robot"></i>
        <span>AI</span>
      </div>
      <div class="nav-item" data-section="music">
        <i class="fas fa-music"></i>
        <span>Music</span>
      </div>
      <div class="nav-item" data-section="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </div>
    </div>

    <!-- Browser Content Area -->
    <div class="browser-content">
      <!-- Welcome Screen -->
      <div class="welcome-screen active" id="welcome-screen">
        <h1>Welcome to ZenZ</h1>
        <p>Your ultra-fast proxy browser experience starts here. Navigate through the web securely and efficiently with our advanced browsing technology.</p>
      </div>

      <!-- Chat Screen -->
      <div class="chat-screen" id="chatting-screen">
        <!-- Online Counter -->
        <div class="online-counter" id="online-counter">
          <div class="online-dot"></div>
          <span id="online-count">0 online</span>
        </div>

        <!-- Username Setup Modal -->
        <div class="username-setup" id="username-setup">
          <h2><i class="fas fa-user"></i> Join Chat</h2>
          <input type="text" id="username-input" placeholder="Enter your username" maxlength="20">
          <button onclick="joinChat()">Start Chatting</button>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
          <!-- Messages Area -->
          <div class="chat-messages" id="chat-messages">
            <div class="message system">
              <div class="message-header">
                <span class="message-sender">System</span>
                <span class="message-time">Now</span>
              </div>
              <div class="message-content">
                Welcome to ZenZ Chat! Enter your username above to connect with other users.
              </div>
            </div>
          </div>

          <!-- Chat Input Area -->
          <div class="chat-input-area">
            <div class="input-group">
              <textarea 
                id="message-input" 
                class="chat-input" 
                placeholder="Enter your username first..."
                disabled
                rows="2"
              ></textarea>
              
              <div class="file-buttons">
                <label for="file-input" class="file-btn">
                  <i class="fas fa-paperclip"></i>
                  Files
                </label>
                <input type="file" id="file-input" class="file-input" multiple>
                
                <label for="image-input" class="file-btn">
                  <i class="fas fa-image"></i>
                  Images
                </label>
                <input type="file" id="image-input" class="file-input" multiple accept="image/*">
              </div>
              
              <div class="selected-files" id="selected-files"></div>
            </div>
            
            <button class="send-button" onclick="sendMessage()" disabled>
              <i class="fas fa-paper-plane"></i>
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal" id="image-modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeImageModal()">&times;</span>
      <img id="modal-image">
    </div>
  </div>

  <script>
    // Real-time chat system using BroadcastChannel for cross-tab communication
    let chatChannel = null;
    let currentUser = null;
    let userId = null;
    let onlineUsers = new Set();
    let selectedFiles = [];

    // Initialize chat system
    function initializeChat() {
      // Create unique user ID
      userId = 'user_' + Math.random().toString(36).substr(2, 9);
      
      // Setup BroadcastChannel for real-time communication
      chatChannel = new BroadcastChannel('zenz_chat');
      
      // Listen for messages from other tabs/windows
      chatChannel.addEventListener('message', handleBroadcastMessage);
      
      // Setup file inputs
      document.getElementById('file-input').addEventListener('change', handleFileSelection);
      document.getElementById('image-input').addEventListener('change', handleFileSelection);
      
      // Setup message input
      const messageInput = document.getElementById('message-input');
      messageInput.addEventListener('keypress', handleKeyPress);
      
      // Request current online users
      broadcastMessage({
        type: 'request_users',
        userId: userId
      });
      
      // Cleanup when page unloads
      window.addEventListener('beforeunload', () => {
        if (currentUser) {
          broadcastMessage({
            type: 'user_left',
            userId: userId,
            username: currentUser
          });
        }
      });
      
      updateOnlineCounter();
    }

    // Handle broadcast messages from other tabs
    function handleBroadcastMessage(event) {
      const data = event.data;
      
      switch (data.type) {
        case 'user_joined':
          if (data.userId !== userId) {
            onlineUsers.add(data.username);
            addSystemMessage(`${data.username} joined the chat`);
            updateOnlineCounter();
            
            // Respond with our user info if we're already connected
            if (currentUser) {
              broadcastMessage({
                type: 'user_response',
                userId: userId,
                username: currentUser,
                targetUserId: data.userId
              });
            }
          }
          break;
          
        case 'user_left':
          if (data.userId !== userId) {
            onlineUsers.delete(data.username);
            addSystemMessage(`${data.username} left the chat`);
            updateOnlineCounter();
          }
          break;
          
        case 'message':
          if (data.userId !== userId) {
            addMessage(data.username, data.content, 'received');
          }
          break;
          
        case 'file_message':
          if (data.userId !== userId) {
            addFileMessage(data.username, data.fileName, data.fileSize, data.fileData, data.fileType, 'received');
          }
          break;
          
        case 'request_users':
          if (data.userId !== userId && currentUser) {
            broadcastMessage({
              type: 'user_response',
              userId: userId,
              username: currentUser,
              targetUserId: data.userId
            });
          }
          break;
          
        case 'user_response':
          if (!data.targetUserId || data.targetUserId === userId) {
            onlineUsers.add(data.username);
            updateOnlineCounter();
          }
          break;
      }
    }

    // Broadcast message to other tabs
    function broadcastMessage(data) {
      if (chatChannel) {
        chatChannel.postMessage(data);
      }
    }

    // Join chat with username
    function joinChat() {
      const input = document.getElementById('username-input');
      const username = input.value.trim();
      
      if (!username) {
        alert('Please enter a username');
        return;
      }
      
      if (username.length > 20) {
        alert('Username must be 20 characters or less');
        return;
      }
      
      if (onlineUsers.has(username)) {
        alert('Username already taken. Please choose another.');
        return;
      }
      
      currentUser = username;
      onlineUsers.add(username);
      
      // Hide username setup
      document.getElementById('username-setup').classList.add('hidden');
      
      // Enable chat
      const messageInput = document.getElementById('message-input');
      messageInput.disabled = false;
      messageInput.placeholder = 'Type your message here...';
      document.querySelector('.send-button').disabled = false;
      messageInput.focus();
      
      // Broadcast that we joined
      broadcastMessage({
        type: 'user_joined',
        userId: userId,
        username: currentUser
      });
      
      updateOnlineCounter();
      addSystemMessage(`You joined as ${username}`);
    }

    // Update online counter
    function updateOnlineCounter() {
      const counter = document.getElementById('online-count');
      const count = onlineUsers.size;
      
      if (count === 0) {
        counter.textContent = 'No one online';
      } else if (count === 1) {
        counter.textContent = '1 person online';
      } else {
        counter.textContent = `${count} people online`;
      }
    }

    // Handle key press
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Send message
    function sendMessage() {
      if (!currentUser) return;
      
      const messageInput = document.getElementById('message-input');
      const message = messageInput.value.trim();
      
      if (!message && selectedFiles.length === 0) return;
      
      // Send text message
      if (message) {
        addMessage(currentUser, message, 'sent');
        broadcastMessage({
          type: 'message',
          userId: userId,
          username: currentUser,
          content: message
        });
      }
      
      // Send file messages
      if (selectedFiles.length > 0) {
        selectedFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const fileData = e.target.result;
            addFileMessage(currentUser, file.name, file.size, fileData, file.type, 'sent');
            broadcastMessage({
              type: 'file_message',
              userId: userId,
              username: currentUser,
              fileName: file.name,
              fileSize: file.size,
              fileData: fileData,
              fileType: file.type
            });
          };
          reader.readAsDataURL(file);
        });
        
        selectedFiles = [];
        updateSelectedFilesDisplay();
      }
      
      // Clear input
      messageInput.value = '';
      messageInput.focus();
    }

    // Add text message to chat
    function addMessage(sender, content, type) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      const isOwn = type === 'sent' || sender === currentUser;
      messageElement.className = `message ${isOwn ? 'own' : ''}`;
      
      messageElement.innerHTML = `
        <div class="message-header">
          <span class="message-sender">${sender}</span>
          <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${escapeHtml(content)}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add system message
    function addSystemMessage(content) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageElement.className = 'message system';
      messageElement.innerHTML = `
        <div class="message-header">
          <span class="message-sender">System</span>
          <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${escapeHtml(content)}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add file message to chat
    function addFileMessage(sender, fileName, fileSize, fileData, fileType, type) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const fileSizeMB = (fileSize / (1024 * 1024)).toFixed(2);
      
      const isOwn = type === 'sent' || sender === currentUser;
      messageElement.className = `message ${isOwn ? 'own' : ''}`;
      
      let fileContent = '';
      if (fileType.startsWith('image/')) {
        fileContent = `
          <img src="${fileData}" alt="${fileName}" class="message-image" onclick="openImageModal('${fileData}')">
        `;
      } else {
        const fileIcon = getFileIcon(fileType);
        fileContent = `
          <div class="message-file">
            <i class="fas fa-${fileIcon} file-icon"></i>
            <div class="file-info">
              <div class="file-name">${escapeHtml(fileName)}</div>
              <div class="file-size">${fileSizeMB} MB</div>
            </div>
            <a href="${fileData}" download="${fileName}" class="file-download">
              <i class="fas fa-download"></i> Download
            </a>
          </div>
        `;
      }
      
      messageElement.innerHTML = `
        <div class="message-header">
          <span class="message-sender">${escapeHtml(sender)}</span>
          <span class="message-time">${time}</span>
        </div>
        <div class="message-content">
          ${fileType.startsWith('image/') ? 'Shared an image:' : 'Shared a file:'}
          ${fileContent}
        </div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle file selection
    function handleFileSelection(event) {
      const files = Array.from(event.target.files);
      
      files.forEach(file => {
        if (selectedFiles.length >= 3) {
          alert('Maximum 3 files can be attached');
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          alert('File size must be less than 10MB');
          return;
        }
        
        selectedFiles.push(file);
      });
      
      updateSelectedFilesDisplay();
      event.target.value = ''; // Reset input
    }

    // Update selected files display
    function updateSelectedFilesDisplay() {
      const container = document.getElementById('selected-files');
      container.innerHTML = '';
      
      selectedFiles.forEach((file, index) => {
        const fileElement = document.createElement('div');
        fileElement.className = 'selected-file';
        fileElement.innerHTML = `
          <i class="fas fa-${getFileIcon(file.type)}"></i>
          ${file.name}
          <span class="remove-file" onclick="removeFile(${index})">&times;</span>
        `;
        container.appendChild(fileElement);
      });
    }

    // Remove selected file
    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateSelectedFilesDisplay();
    }

    // Get file icon based on type
    function getFileIcon(type) {
      if (type.startsWith('image/')) return 'image';
      if (type.startsWith('video/')) return 'video';
      if (type.startsWith('audio/')) return 'music';
      if (type.includes('pdf')) return 'file-pdf';
      if (type.includes('word') || type.includes('document')) return 'file-word';
      if (type.includes('excel') || type.includes('spreadsheet')) return 'file-excel';
      if (type.includes('powerpoint') || type.includes('presentation')) return 'file-powerpoint';
      if (type.includes('zip') || type.includes('rar')) return 'file-archive';
      return 'file';
    }

    // Open image modal
    function openImageModal(imageSrc) {
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      
      modalImage.src = imageSrc;
      modal.classList.add('active');
    }

    // Close image modal
    function closeImageModal() {
      const modal = document.getElementById('image-modal');
      modal.classList.remove('active');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Section switching functionality
    function switchSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.welcome-screen, .chat-screen').forEach(screen => {
        screen.classList.remove('active');
      });
      
      // Show selected section
      const sectionElement = document.getElementById(`${sectionName}-screen`);
      if (sectionElement) {
        sectionElement.classList.add('active');
      }
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      const navItem = document.querySelector(`[data-section="${sectionName}"]`);
      if (navItem) navItem.classList.add('active');
      
      // Initialize chat if switching to chat section
      if (sectionName === 'chatting') {
        setTimeout(initializeChat, 100);
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Navigation event listeners
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const section = item.dataset.section;
          switchSection(section);
        });
      });
      
      // Start with welcome screen
      switchSection('welcome');
      
      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.classList.remove('active');
        }
      });
      
      // Handle escape key for modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.active').forEach(modal => {
            modal.classList.remove('active');
          });
        }
      });
      
      // Handle username input enter key
      document.addEventListener('keypress', (e) => {
        if (e.target.id === 'username-input' && e.key === 'Enter') {
          joinChat();
        }
      });
    });
  </script>
</body>
</html>
